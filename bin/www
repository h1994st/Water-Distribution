#!/usr/bin/env node
var debug = require('debug')('WaterDistribution');
var app = require('../app');
var http = require('http').Server(app);

app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});

var io = require('socket.io')(server);

io.on('connection', function (socket) {
  console.log('a user connected');
});

var misc = require('../misc').global;
var WaterController = require('../WaterController');
var WaterRecycler = require('../WaterRecycler');

var waterRecycler = new WaterRecycler();
misc.waterRecycler = waterRecycler;

misc.io = io;

var controller = new WaterController();
controller.initWaterBox();

setInterval(function () {
  setTimeout(function () {
    // console.log();
    // console.log();
    var p = Math.floor(Math.random() * 100);
    io.emit('console', new Date());
    var w = Math.floor(Math.random() * 20);
    io.emit('console', 'Use Water: ' + w);
    if (p < 20) {
      controller.water_box[0].useWater(w);
    } else if (p < 75) {
      controller.water_box[1].useWater(w);
    } else {
      controller.water_box[2].useWater(w);
    }
    // output();
  }, Math.floor(Math.random() * 1000));
}, 1000);

setInterval(function(){
	io.emit('waterbox', [controller.water_box[0].amount, controller.water_box[1].amount, controller.water_box[2].amount]);
	io.emit('recycler', misc.waterRecycler.amount);
	io.emit('input', [misc._input, misc._input_compare]);
  }, 1000);

var output = function(){
  console.log('总输入量：' + misc._input);
  console.log('对比输入量：' + misc._input_compare);
  console.log('用户需水池状况：');
  console.log('A水箱水量：' + controller.water_box[0].amount);
  console.log('B水箱水量：' + controller.water_box[1].amount);
  console.log('C水箱水量：' + controller.water_box[2].amount);
  console.log('净水设施水存储状况：');
  console.log('A类水剩余：' + misc.waterRecycler.amount[0]);
  console.log('B类水剩余：' + misc.waterRecycler.amount[1]);
  console.log('C类水剩余：' + misc.waterRecycler.amount[2]);
}
